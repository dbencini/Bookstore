<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Workshop Tasks</h2>
        <div class="mb-3 text-secondary">
            Total Tasks: <strong>
                <%= totalItems %>
            </strong> (Page <%= currentPage %>)
        </div>
    </div>

    <!-- Advanced Search Card (Style Reference: capture_form1.md) -->
    <div class="card mb-3 admin-panel-dark">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span class="fw-bold">Search & Filter</span>
        </div>
        <div class="card-body">
            <form action="/admin/workshop" method="GET" id="searchForm" class="row g-3 align-items-center">
                <div class="col-md-5">
                    <label for="searchInput" class="form-label small text-muted">Search by Book Title or ISBN</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" name="search" id="searchInput"
                            placeholder="e.g. Harry Potter..." value="<%= searchQuery %>">
                        <span class="input-group-text d-none text-muted" id="searchStatus"
                            style="min-width: 80px;">Waiting...</span>
                    </div>
                </div>
                <div class="col-md-2">
                    <label for="orderIdInput" class="form-label small text-muted">Filter by Order ID</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-upc-scan"></i></span>
                        <input type="text" class="form-control" name="orderId" id="orderIdInput"
                            placeholder="e.g. 55F..." value="<%= orderIdQuery %>">
                    </div>
                </div>
                <div class="col-md-2">
                    <label for="sourceInput" class="form-label small text-muted">Filter by Source</label>
                    <select class="form-select" id="sourceInput" name="source">
                        <option value="All" <%=sourceFilter==='All' ? 'selected' : '' %>>All Sources</option>
                        <option value="Website" <%=sourceFilter==='Website' ? 'selected' : '' %>>Website Only</option>
                        <option value="Cloud Print" <%=sourceFilter==='Cloud Print' ? 'selected' : '' %>>CloudPrint Only
                        </option>
                    </select>
                </div>
                <div class="col-md-3">
                    <div class="form-check form-switch pt-2">
                        <input class="form-check-input" type="checkbox" id="showIncomplete" name="showIncomplete"
                            value="true" <%=showIncomplete ? 'checked' : '' %>>
                        <label class="form-check-label" for="showIncomplete">Pending Only</label>
                        <!-- CloudPrint Details Modal -->
                        <div class="modal fade" id="cpDetailsModal" tabindex="-1" aria-hidden="true">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content admin-panel-dark">
                                    <div class="modal-header">
                                        <h5 class="modal-title">CloudPrinter Order Details</h5>
                                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                                            aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body" id="cpDetailsContent">
                                        <!-- Loaded via AJAX -->
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary"
                                            data-bs-dismiss="modal">Close</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Submit button removed for live search -->
            </form>
        </div>
    </div>

    <!-- Data Grid Container -->
    <div id="gridContainer" class="table-responsive admin-panel-dark p-2 rounded">
        <%- include('partials/workshop-grid') %>
    </div>
</div>

<style>
    /* Admin Grid Styles from capture_form1.md */


    [data-theme="dark"] .admin-panel-dark {
        background-color: #343a40 !important;
        color: #f8f9fa !important;
        border-color: #454d55 !important;
    }

    [data-theme="dark"] .admin-panel-dark .card-header {
        background-color: #343a40;
        border-bottom-color: #454d55;
    }

    [data-theme="dark"] .admin-panel-dark .card-body {
        background-color: #454d55;
        color: #e0e0e0;
    }

    [data-theme="dark"] .table {
        color: #f8f9fa;
        border-color: #565e64;
    }

    [data-theme="dark"] .table-light th {
        background-color: #343a40;
        color: #f8f9fa;
        border-color: #565e64;
    }

    [data-theme="dark"] .form-control {
        background-color: #454d55;
        border-color: #565e64;
        color: #e0e0e0;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const gridContainer = document.getElementById('gridContainer');
        const searchInput = document.getElementById('searchInput');
        const orderIdInput = document.getElementById('orderIdInput');
        const sourceInput = document.getElementById('sourceInput');
        const searchForm = document.getElementById('searchForm');
        const searchStatus = document.getElementById('searchStatus');
        const showIncompleteToggle = document.getElementById('showIncomplete');

        let searchTimeout;
        let currentPage = 1;

        // Function to Reload Grid via AJAX
        async function reloadGrid(page = 1) {
            currentPage = page;
            const search = searchInput.value;
            const orderId = orderIdInput.value;
            const source = sourceInput.value;
            const showIncomplete = showIncompleteToggle.checked;

            // Visual Feedback
            searchStatus.classList.remove('d-none');
            searchStatus.textContent = 'Loading...';
            gridContainer.style.opacity = '0.5';

            try {
                const url = `/admin/workshop?ajax=true&search=${encodeURIComponent(search)}&orderId=${encodeURIComponent(orderId)}&source=${encodeURIComponent(source)}&showIncomplete=${showIncomplete}&page=${page}`;
                const res = await fetch(url);
                const html = await res.text();

                gridContainer.innerHTML = html;
                gridContainer.style.opacity = '1';
                searchStatus.classList.add('d-none');

                // Re-attach listeners to new content
                attachToggleListeners();
                attachPaginationListeners();
                attachFileListeners();
                attachDetailsListeners();
            } catch (err) {
                console.error('Grid load error:', err);
                searchStatus.textContent = 'Error';
            }
        }

        // Generic Input Listener for debounce logic
        function attachInputListener(inputEl) {
            if (inputEl) {
                if (inputEl.value) {
                    const val = inputEl.value;
                    inputEl.focus();
                    inputEl.value = '';
                    inputEl.value = val;
                }

                inputEl.addEventListener('input', function () {
                    clearTimeout(searchTimeout);
                    searchStatus.classList.remove('d-none');
                    searchStatus.textContent = 'Waiting...';

                    searchTimeout = setTimeout(() => {
                        reloadGrid(1);
                    }, 2000);
                });
            }
        }

        attachInputListener(searchInput);
        attachInputListener(orderIdInput);

        // Toggle "Pending Only" Listener
        if (showIncompleteToggle) {
            showIncompleteToggle.addEventListener('change', function () {
                reloadGrid(1);
            });
        }

        if (sourceInput) {
            sourceInput.addEventListener('change', function () {
                reloadGrid(1);
            });
        }

        // Pagination Listeners
        function attachPaginationListeners() {
            document.querySelectorAll('.ajax-link').forEach(link => {
                // Remove old listeners by cloning or just relying on fresh DOM from AJAX
                // Since this is called on reload, fresh DOM is guaranteed. 
                // For initial load, standard listener.
                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    const page = this.dataset.page;
                    reloadGrid(page);
                });
            });
        }

        // Checkbox Toggle Listeners (Row logic)
        function attachToggleListeners() {
            document.querySelectorAll('.ws-toggle').forEach(chk => {
                chk.addEventListener('change', async function () {
                    const workshopId = this.dataset.id;
                    const field = this.dataset.field;
                    const value = this.checked;
                    const dateEl = document.getElementById(`date-${field}-${workshopId}`);
                    const row = document.getElementById(`row-${workshopId}`);

                    try {
                        const res = await fetch('/admin/workshop/update', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ workshopId, field, value })
                        });
                        const data = await res.json();

                        if (data.success) {
                            // Show Completion Badge if entire order is done
                            if (data.orderCompleted) {
                                showCompletionBadge(data.completedOrderId);
                            }

                            // User Request: If filtered and we tick a box, clear filter to show all rows
                            if (value && searchInput.value.trim() !== '') {
                                searchInput.value = '';
                                reloadGrid(1);
                                return;
                            }

                            // Update date display
                            dateEl.textContent = value ? new Date().toLocaleDateString() : '-';

                            // Check for Row Removal Logic (if Pending Only is ON)
                            if (showIncompleteToggle && showIncompleteToggle.checked) {
                                // Find sibling checkbox
                                const otherField = field === 'threeKnife' ? 'dispatch' : 'threeKnife';
                                const otherChk = row.querySelector(`.ws-toggle[data-field="${otherField}"]`);

                                // If BOTH are now checked (complete), remove row
                                if (value && otherChk && otherChk.checked) {
                                    row.classList.add('table-success');

                                    // Animate and Remove
                                    setTimeout(() => {
                                        row.style.transition = 'all 0.5s ease';
                                        row.style.opacity = '0';
                                        row.style.transform = 'translateX(20px)';

                                        setTimeout(() => {
                                            if (row.parentNode) {
                                                row.remove();
                                            }
                                        }, 500);
                                    }, 300);
                                }
                            }
                        } else {
                            throw new Error(data.error);
                        }
                    } catch (err) {
                        alert('Error updating status: ' + err.message);
                        this.checked = !this.checked; // Revert
                    }
                });
            });
        }

        function showCompletionBadge(orderId) {
            // Create Badge Element
            const badge = document.createElement('div');
            const shortId = orderId ? orderId.split('-')[0].toUpperCase() : '???';
            badge.className = 'floating-badge';
            badge.innerHTML = `<i class="bi bi-check-circle-fill me-2"></i> Order ${shortId} has been completed`;
            document.body.appendChild(badge);

            // Animate In (handled by CSS keyframes usually, or JS transition)
            // We'll use JS for simple enter/exit
            requestAnimationFrame(() => {
                badge.style.bottom = '50px'; // Move up
                badge.style.opacity = '1';
            });

            // Remove after 3s
            setTimeout(() => {
                badge.style.opacity = '0';
                badge.style.bottom = '20px'; // Move down
                setTimeout(() => badge.remove(), 500);
            }, 3500);
        }

        // Initial Attach
        attachToggleListeners();
        attachPaginationListeners();
        attachFileListeners();
        attachDetailsListeners();

        function attachDetailsListeners() {
            document.querySelectorAll('.view-cp-details').forEach(btn => {
                btn.addEventListener('click', async function () {
                    const orderId = this.dataset.id;
                    if (!orderId) return;

                    // Show Modal with Loading
                    const modal = new bootstrap.Modal(document.getElementById('cpDetailsModal'));
                    document.getElementById('cpDetailsContent').innerHTML = '<div class="text-center p-4"><div class="spinner-border text-primary"></div></div>';
                    modal.show();

                    try {
                        const res = await fetch(`/admin/cloudprinter/order-details/${orderId}`);

                        const contentType = res.headers.get("content-type");
                        if (contentType && contentType.indexOf("application/json") !== -1) {
                            const data = await res.json();
                            if (data.success) {
                                renderCpDetails(data.order, data.extra);
                            } else {
                                document.getElementById('cpDetailsContent').innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                            }
                        } else {
                            const text = await res.text();
                            console.error('Non-JSON response:', text);
                            document.getElementById('cpDetailsContent').innerHTML = `<div class="alert alert-danger">Server Error (Check Console)</div>`;
                        }
                    } catch (err) {
                        console.error(err);
                        document.getElementById('cpDetailsContent').innerHTML = `<div class="alert alert-danger">Network Error: ${err.message}</div>`;
                    }
                });
            });
        }

        function renderCpDetails(order, extra) {
            const shipping = extra.shipping || {};
            const client = extra.client || {};
            const items = order.CpOrderItems || [];
            const addresses = order.CpAddresses || [];

            let html = `
                <div class="row mb-3">
                    <div class="col-md-6">
                        <h6>Order Info</h6>
                        <table class="table table-sm table-borderless">
                            <tr><td><strong>CP ID:</strong></td><td>${order.cpOrderId}</td></tr>
                            <tr><td><strong>Date:</strong></td><td>${new Date(order.orderDate).toLocaleString()}</td></tr>
                            <tr><td><strong>Status:</strong></td><td><span class="badge bg-secondary">${order.status}</span></td></tr>
                            <tr><td><strong>Reference:</strong></td><td>${order.clientReference || '-'}</td></tr>
                             <tr><td><strong>Priority:</strong></td><td>${extra.priority || '-'}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Shipping</h6>
                        <p class="small mb-1"><strong>Method:</strong> ${shipping.method || '-'}</p>
                         <p class="small mb-1"><strong>Consignor:</strong> ${shipping.consignor || '-'}</p>
                    </div>
                </div>

                <h6>Addresses</h6>
                <div class="row mb-3">
                    ${addresses.map(addr => `
                        <div class="col-md-6">
                            <div class="card card-body bg-light p-2 mb-2">
                                <strong class="text-capitalize">${addr.type}</strong><br>
                                ${addr.company ? addr.company + '<br>' : ''}
                                ${addr.name}<br>
                                ${addr.street1} ${addr.street2 || ''}<br>
                                ${addr.city}, ${addr.state || ''} ${addr.zip}<br>
                                ${addr.country}<br>
                                <small>Email: ${addr.email || '-'}</small>
                            </div>
                        </div>
                    `).join('')}
                </div>

                <h6>Items</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <thead class="table-light">
                            <tr><th>Title</th><th>Qty</th><th>Product</th><th>Options</th></tr>
                        </thead>
                        <tbody>
                            ${items.map((item, idx) => {
                // Try to match with extra.rawItems if available
                const rawItem = extra.rawItems && extra.rawItems.length > idx ? extra.rawItems[idx] : {};
                const options = rawItem.options || [];
                const optionsList = options.map(opt =>
                    `<li><strong>${opt.type}:</strong> ${opt.desc}</li>`
                ).join('');

                const files = item.CpFiles || [];
                const fileLinks = files.map(f => {
                    if (f.localPath) {
                        // It's in the public/hotfolder, accessible via web
                        const localUrl = `/hotfolder/${f.type}_${f.id}.pdf`;
                        return `<a href="${localUrl}" target="_blank" class="badge bg-success text-white text-decoration-none border me-1">
                                            <i class="bi bi-check-circle-fill"></i> ${f.type.toUpperCase()} (Local)
                                        </a>`;
                    } else {
                        return `<a href="${f.url}" target="_blank" class="badge bg-light text-dark text-decoration-none border me-1">
                                            <i class="bi bi-file-earmark-pdf text-danger"></i> ${f.type.toUpperCase()}
                                        </a>`;
                    }
                }).join('');

                const isbn = item.Workshop ? item.Workshop.isbn : '-';

                return `
                                    <tr>
                                        <td>
                                            ${item.title}<br>
                                            <span class="text-muted small">ISBN: ${isbn}</span>
                                        </td>
                                        <td>${item.quantity}</td>
                                        <td>${item.productCode}</td>
                                        <td>
                                            <ul class="mb-1 ps-3">${optionsList || '-'}</ul>
                                            <div class="mt-1">${fileLinks}</div>
                                        </td>
                                    </tr>
                                `;
            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            document.getElementById('cpDetailsContent').innerHTML = html;
        }

        function attachFileListeners() {
            // Download (Hotfolder)
            document.querySelectorAll('.download-file-btn').forEach(btn => {
                btn.addEventListener('click', async function () {
                    const cpFileId = this.dataset.id;
                    const originalText = this.innerHTML;
                    this.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
                    this.disabled = true;

                    try {
                        const res = await fetch('/admin/cloudprinter/download-file', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ cpFileId })
                        });

                        const contentType = res.headers.get("content-type");
                        if (contentType && contentType.indexOf("application/json") !== -1) {
                            const data = await res.json();
                            if (data.success) {
                                // Success Feedback
                                this.innerHTML = '<span class="badge bg-success">Downloaded</span>';
                                this.disabled = true;

                                showToast(`File sent to hotfolder!`, 'success');

                                // Reload grid to update Links
                                setTimeout(() => reloadGrid(currentPage), 1000);

                            } else {
                                alert('Error: ' + data.error);
                                this.innerHTML = originalText;
                                this.disabled = false;
                            }
                        } else {
                            const text = await res.text();
                            console.error('Non-JSON response:', text);
                            alert('Server Error (Check Console)');
                            this.innerHTML = originalText;
                            this.disabled = false;
                        }
                    } catch (err) {
                        console.error(err);
                        alert('Network Error: ' + err.message);
                        this.innerHTML = originalText;
                        this.disabled = false;
                    }
                });
            });

            // Delete (Hotfolder)
            document.querySelectorAll('.delete-file-btn').forEach(btn => {
                btn.addEventListener('click', async function () {
                    if (!confirm('Are you sure you want to delete this file from the hotfolder?')) return;

                    const cpFileId = this.dataset.id;
                    try {
                        const res = await fetch('/admin/cloudprinter/delete-file', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ cpFileId })
                        });

                        const contentType = res.headers.get("content-type");
                        if (contentType && contentType.indexOf("application/json") !== -1) {
                            const data = await res.json();
                            if (data.success) {
                                reloadGrid(currentPage);
                            } else {
                                alert('Error: ' + data.error);
                            }
                        } else {
                            const text = await res.text();
                            console.error('Non-JSON response:', text);
                            alert('Server Error (Check Console)');
                        }
                    } catch (err) {
                        console.error(err);
                        alert('Network Error: ' + err.message);
                    }
                });
            });
        }

        function showToast(message, type = 'success') {
            const badge = document.createElement('div');
            badge.className = 'floating-badge';
            if (type === 'error') badge.style.backgroundColor = '#dc3545';

            badge.innerHTML = `<i class="bi bi-${type === 'success' ? 'check-circle-fill' : 'exclamation-circle-fill'} me-2"></i> ${message}`;
            document.body.appendChild(badge);

            requestAnimationFrame(() => {
                badge.style.transform = 'translate(-50%, -50%) scale(1)';
                badge.style.opacity = '1';
            });

            setTimeout(() => {
                badge.style.opacity = '0';
                badge.style.transform = 'translate(-50%, -50%) scale(0.8)';
                setTimeout(() => badge.remove(), 500);
            }, 3000);
        }

    });
</script>

<style>
    .floating-badge {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.8);
        background-color: #198754;
        /* Success Green */
        color: white;
        padding: 20px 40px;
        border-radius: 10px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
        font-weight: bold;
        z-index: 9999;
        opacity: 0;
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        display: flex;
        align-items: center;
        font-size: 1.2rem;
    }
</style>