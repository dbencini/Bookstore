<div class="container mt-4">
    <h2>Book Management</h2>

    <div class="mb-3 text-secondary">
        Total Books: <strong>
            <%= totalBooks %>
        </strong> (Page <%= currentPage %>)
    </div>

    <!-- Advanced Search & Filter -->
    <div class="card mb-3 admin-panel-dark">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span class="fw-bold">Advanced Search</span>
            <button class="btn btn-sm btn-outline-light" type="button" data-bs-toggle="collapse"
                data-bs-target="#searchPanel">
                <i class="bi bi-funnel"></i> Toggle Filters
            </button>
        </div>
        <div class="collapse <%= (filters && (filters.title || filters.author || filters.isbn || filters.category || filters.startDate || filters.endDate)) ? 'show' : '' %>"
            id="searchPanel">
            <div class="card-body">
                <form action="/admin/books" method="GET" class="row g-3" id="adminSearchForm">
                    <div class="col-md-3">
                        <label class="form-label">Title</label>
                        <input type="text" name="title" class="form-control form-control-sm"
                            value="<%= filters?.title || '' %>" placeholder="Contains...">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Author</label>
                        <input type="text" name="author" class="form-control form-control-sm"
                            value="<%= filters?.author || '' %>" placeholder="Contains...">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">ISBN</label>
                        <input type="text" name="isbn" class="form-control form-control-sm"
                            value="<%= filters?.isbn || '' %>" placeholder="Contains...">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Category</label>
                        <select name="category" class="form-select form-select-sm">
                            <option value="">All Categories</option>
                            <% categories.forEach(cat=> { %>
                                <option value="<%= cat.name %>" <%=filters?.category===cat.name ? 'selected' : '' %>>
                                    <%= cat.name %>
                                </option>
                                <% }) %>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Date Range</label>
                        <div class="input-group input-group-sm">
                            <input type="date" name="startDate" class="form-control"
                                value="<%= filters?.startDate || '' %>">
                            <span class="input-group-text">-</span>
                            <input type="date" name="endDate" class="form-control"
                                value="<%= filters?.endDate || '' %>">
                        </div>
                    </div>
                    <div class="col-12 text-end">
                        <a href="/admin/books" class="btn btn-sm btn-secondary me-2" id="btnClearFilters">Clear</a>
                        <button type="submit" class="btn btn-sm btn-primary">Search</button>
                    </div>
                </form>

                <!-- Quick Filters for Missing Data -->
                <div class="mt-3 pt-3 border-top">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small class="text-muted fw-bold">Quick Filters:</small>
                        <span class="badge bg-secondary">Total: <%= totalBooks %></span>
                    </div>
                    <div class="d-flex gap-2 flex-wrap">
                        <a href="/admin/books?filter=missing_author" class="btn btn-sm btn-outline-warning">
                            <i class="bi bi-person-x"></i> Missing Authors
                        </a>
                        <a href="/admin/books?filter=missing_image" class="btn btn-sm btn-outline-warning">
                            <i class="bi bi-image"></i> Missing Images
                        </a>
                        <a href="/admin/books?filter=missing_title" class="btn btn-sm btn-outline-warning">
                            <i class="bi bi-file-text"></i> Missing Titles
                        </a>
                        <a href="/admin/books?filter=missing_description" class="btn btn-sm btn-outline-warning">
                            <i class="bi bi-card-text"></i> Missing Descriptions
                        </a>
                        <a href="/admin/books?filter=missing_price" class="btn btn-sm btn-outline-danger">
                            <i class="bi bi-currency-dollar"></i> Missing Price
                        </a>
                        <a href="/admin/books?filter=incomplete" class="btn btn-sm btn-outline-danger">
                            <i class="bi bi-exclamation-triangle"></i> Incomplete (Hidden)
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>





    <style>
        .clickable-row {
            cursor: pointer;
        }

        .clickable-row:hover {
            background-color: rgba(255, 255, 255, 0.05) !important;
        }

        .table-highlight {
            background-color: rgba(0, 123, 255, 0.2) !important;
        }
    </style>

    <table class="table table-striped align-middle">
        <thead>
            <tr>
                <th style="width: 80px;">Cover</th>
                <th>Title / Author</th>
                <th>ISBN</th>
                <th>Price</th>
                <th>Category</th>
                <th>Date Added</th>
                <th>Updated At</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <% books.forEach(book=> { %>
                <tr id="tr-<%= book.id %>" class="clickable-row" data-id="<%= book.id %>" data-title="<%= book.title %>"
                    data-author="<%= book.author %>" data-isbn="<%= book.isbn || '' %>" data-price="<%= book.price %>"
                    data-price-cost="<%= book.price_cost %>"
                    data-categories='<%= JSON.stringify((book.Categories || []).map(c => c.id)) %>'
                    data-image="<%= book.imageUrl %>" data-stock="<%= book.stock %>"
                    data-is-visible="<%= book.isVisible %>"
                    data-created-at="<%= new Date(book.createdAt).toLocaleString() %>"
                    data-updated-at="<%= new Date(book.updatedAt).toLocaleString() %>">
                    <td>
                        <img src="<%= book.imageUrl %>" alt="Cover" class="img-thumbnail" style="height: 60px;"
                            referrerpolicy="no-referrer">
                    </td>
                    <td>
                        <strong>
                            <%= book.title %>
                        </strong><br>
                        <small class="text-muted">
                            <%= book.author %>
                        </small>
                    </td>
                    <td>
                        <%= book.isbn || '-' %>
                    </td>
                    <td>
                        R<%= book.price ? parseFloat(book.price).toFixed(2) : '0.00' %>
                    </td>
                    <td>
                        <% if (book.Categories && book.Categories.length> 0) { %>
                            <% book.Categories.slice(0, 3).forEach(cat=> { %>
                                <span class="badge bg-secondary mb-1">
                                    <%= cat.name %>
                                </span>
                                <% }) %>
                                    <% if (book.Categories.length> 3) { %>
                                        <span class="badge bg-dark mb-1">+<%= book.Categories.length - 3 %></span>
                                        <% } %>
                                            <% } else { %>
                                                <span class="text-muted small">Uncategorized</span>
                                                <% } %>
                    </td>
                    <td>
                        <%= new Date(book.createdAt).toLocaleDateString() %>
                    </td>
                    <td>
                        <%= new Date(book.updatedAt).toLocaleDateString() %>
                    </td>
                    <td>
                        <% if (book.isVisible) { %>
                            <span class="badge bg-success">Visible</span>
                            <% } else { %>
                                <span class="badge bg-warning text-dark">Hidden</span>
                                <% } %>
                    </td>
                    <td>
                        <div class="d-flex gap-2">
                            <!-- Toggle Visibility -->
                            <button type="button"
                                class="btn btn-sm <%= book.isVisible ? 'btn-outline-warning' : 'btn-outline-success' %> btn-toggle-visibility"
                                data-id="<%= book.id %>" data-visible="<%= book.isVisible %>"
                                title="<%= book.isVisible ? 'Hide Book' : 'Show Book' %>">
                                <i class="bi <%= book.isVisible ? 'bi-eye-slash' : 'bi-eye' %>"></i>
                            </button>

                            <!-- Hidden Description to avoid Quote/Newline attribute issues -->
                            <div id="desc-<%= book.id %>" class="d-none">
                                <%= book.description %>
                            </div>
                        </div>
                    </td>
                </tr>
                <% }) %>
        </tbody>
    </table>

    <!-- Pagination -->
    <% if (totalPages> 1) { %>
        <div class="p-2 rounded mt-3">
            <nav aria-label="Book navigation">
                <ul class="pagination justify-content-center mb-0">
                    <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
                        <a class="page-link"
                            href="/admin/books?page=<%= currentPage - 1 %>&title=<%= encodeURIComponent(filters.title) %>&author=<%= encodeURIComponent(filters.author) %>&category=<%= encodeURIComponent(filters.category) %>&isbn=<%= encodeURIComponent(filters.isbn) %>&startDate=<%= encodeURIComponent(filters.startDate) %>&endDate=<%= encodeURIComponent(filters.endDate) %>">Previous</a>
                    </li>
                    <% let startPage=Math.max(1, currentPage - 2); let endPage=Math.min(totalPages, currentPage + 2); if
                        (startPage> 1) { %>
                        <li class="page-item">
                            <a class="page-link"
                                href="/admin/books?page=1&title=<%= encodeURIComponent(filters.title) %>&author=<%= encodeURIComponent(filters.author) %>&category=<%= encodeURIComponent(filters.category) %>&isbn=<%= encodeURIComponent(filters.isbn) %>&startDate=<%= encodeURIComponent(filters.startDate) %>&endDate=<%= encodeURIComponent(filters.endDate) %>">1</a>
                        </li>
                        <% if (startPage> 2) { %>
                            <li class="page-item disabled"><span class="page-link">...</span></li>
                            <% } %>
                                <% } %>

                                    <% for(let i=startPage; i <=endPage; i++) { %>
                                        <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                                            <a class="page-link"
                                                href="/admin/books?page=<%= i %>&title=<%= encodeURIComponent(filters.title) %>&author=<%= encodeURIComponent(filters.author) %>&category=<%= encodeURIComponent(filters.category) %>&isbn=<%= encodeURIComponent(filters.isbn) %>&startDate=<%= encodeURIComponent(filters.startDate) %>&endDate=<%= encodeURIComponent(filters.endDate) %>">
                                                <%= i %>
                                            </a>
                                        </li>
                                        <% } %>

                                            <% if (endPage < totalPages) { %>
                                                <% if (endPage < totalPages - 1) { %>
                                                    <li class="page-item disabled"><span class="page-link">...</span>
                                                    </li>
                                                    <% } %>
                                                        <li class="page-item">
                                                            <a class="page-link"
                                                                href="/admin/books?page=<%= totalPages %>&title=<%= encodeURIComponent(filters.title) %>&author=<%= encodeURIComponent(filters.author) %>&category=<%= encodeURIComponent(filters.category) %>&isbn=<%= encodeURIComponent(filters.isbn) %>&startDate=<%= encodeURIComponent(filters.startDate) %>&endDate=<%= encodeURIComponent(filters.endDate) %>">
                                                                <%= totalPages %>
                                                            </a>
                                                        </li>
                                                        <% } %>
                                                            <li
                                                                class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
                                                                <a class="page-link"
                                                                    href="/admin/books?page=<%= currentPage + 1 %>&title=<%= encodeURIComponent(filters.title) %>&author=<%= encodeURIComponent(filters.author) %>&category=<%= encodeURIComponent(filters.category) %>&isbn=<%= encodeURIComponent(filters.isbn) %>&startDate=<%= encodeURIComponent(filters.startDate) %>&endDate=<%= encodeURIComponent(filters.endDate) %>">Next</a>
                                                            </li>
                </ul>
            </nav>
        </div>
        <% } %>

            <a href="/admin" class="btn btn-secondary mt-3">Back to Dashboard</a>

            <!-- Draggable Edit Modal -->
            <div class="modal fade" id="editBookModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
                <div class="modal-dialog modal-dialog-centered modal-lg" style="min-width: 600px;">
                    <div class="modal-content" style="min-height: 500px;">
                        <div class="modal-header bg-primary text-white" style="cursor: move;">
                            <h5 class="modal-title">Edit Book</h5>
                            <div class="d-flex gap-2 align-items-center">
                                <button type="button" id="btnFetchGoogleData" class="btn btn-sm btn-warning"
                                    title="Fetch data from Google Books API">
                                    <i class="bi bi-cloud-download"></i> Fetch from Google
                                </button>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                        </div>
                        <div class="modal-body">
                            <form id="updateBookForm" method="POST">
                                <input type="hidden" id="modalBookId" value="">
                                <div class="modal-body">
                                    <div class="row g-3">
                                        <!-- Left Column: Image -->
                                        <div class="col-md-4 text-center">
                                            <img id="modalBookThumbnail" src="" alt="Cover"
                                                class="img-fluid rounded shadow mb-2" style="max-height: 250px;"
                                                referrerpolicy="no-referrer">
                                            <div class="small text-muted mb-1">Created: <span
                                                    id="modalCreatedAt"></span>
                                            </div>
                                            <div class="small text-muted">Updated: <span id="modalUpdatedAt"></span>
                                            </div>
                                        </div>

                                        <!-- Right Column: Details -->
                                        <div class="col-md-8">
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">Title</label>
                                                <input type="text" id="modalBookTitle" class="form-control" disabled
                                                    readonly>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">Author</label>
                                                <input type="text" id="modalBookAuthor" class="form-control" disabled
                                                    readonly>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">ISBN</label>
                                                <input type="text" name="isbn" id="modalBookIsbn" class="form-control">
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">Description</label>
                                                <textarea name="description" id="modalBookDescription"
                                                    class="form-control" rows="3"></textarea>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-4 mb-3">
                                                    <label class="form-label fw-bold">Categories</label>
                                                    <div id="categoryCheckboxContainer"
                                                        class="form-control overflow-auto bg-light"
                                                        style="height: 120px; border: 1px solid #dee2e6;">
                                                        <% categories.forEach(cat=> { %>
                                                            <div class="form-check ms-2">
                                                                <input class="form-check-input category-checkbox"
                                                                    type="checkbox" value="<%= cat.id %>"
                                                                    id="cat-check-<%= cat.id %>">
                                                                <label class="form-check-label"
                                                                    for="cat-check-<%= cat.id %>">
                                                                    <%= cat.name %>
                                                                </label>
                                                            </div>
                                                            <% }) %>
                                                    </div>
                                                    <small class="text-muted">Select all that apply</small>
                                                </div>
                                                <div class="col-md-4 mb-3">
                                                    <label class="form-label fw-bold">Price (R)</label>
                                                    <input type="number" name="price" id="modalBookPrice"
                                                        class="form-control" step="0.01" min="0">
                                                </div>
                                                <div class="col-md-4 mb-3">
                                                    <label class="form-label fw-bold">Cost Price (R)</label>
                                                    <input type="number" name="price_cost" id="modalBookPriceCost"
                                                        class="form-control" step="0.01" min="0">
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label fw-bold">Stock</label>
                                                    <input type="number" name="stock" id="modalBookStock"
                                                        class="form-control" min="0">
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label fw-bold">Image URL</label>
                                                    <input type="text" name="imageUrl" id="modalBookImage"
                                                        class="form-control">
                                                </div>
                                            </div>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" name="isVisible"
                                                    id="modalBookVisible">
                                                <label class="form-check-label fw-bold" for="modalBookVisible">Book is
                                                    Visible</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer justify-content-between">
                                    <button type="button" id="btnDeleteBook" class="btn btn-danger">Delete</button>
                                    <button type="submit" class="btn btn-primary">Update Book</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <script>
                    document.addEventListener('DOMContentLoaded', function () {
                        // --- Filter Persistence ---
                        const FILTER_STORAGE_KEY = 'admin_books_filters';
                        const adminSearchForm = document.getElementById('adminSearchForm');
                        const btnClearFilters = document.getElementById('btnClearFilters');

                        // Save Filters on Submit
                        if (adminSearchForm) {
                            adminSearchForm.addEventListener('submit', function () {
                                const formData = new FormData(adminSearchForm);
                                const params = new URLSearchParams(formData);
                                localStorage.setItem(FILTER_STORAGE_KEY, params.toString());
                            });
                        }

                        // Clear Filters
                        if (btnClearFilters) {
                            btnClearFilters.addEventListener('click', function (e) {
                                localStorage.removeItem(FILTER_STORAGE_KEY);
                            });
                        }

                        // Restore Filters if none in URL
                        const currentQuery = window.location.search;
                        const savedQuery = localStorage.getItem(FILTER_STORAGE_KEY);
                        if (!currentQuery && savedQuery && savedQuery !== 'title=&author=&isbn=&category=&startDate=&endDate=') {
                            window.location.search = savedQuery;
                            return; // Wait for reload
                        }

                        // --- Persistent Row Highlighting ---
                        const STORAGE_KEY = 'admin_last_clicked_book_id';
                        const savedId = localStorage.getItem(STORAGE_KEY);

                        // Restore Highlight
                        if (savedId) {
                            const row = document.getElementById('tr-' + savedId);
                            if (row) {
                                row.classList.add('table-highlight');
                                // row.scrollIntoView({ behavior: 'smooth', block: 'center' }); // Optional: Scroll to it
                            }
                        }

                        const editModalEl = document.getElementById('editBookModal');
                        const editModal = new bootstrap.Modal(editModalEl);
                        const updateForm = document.getElementById('updateBookForm');
                        const btnDelete = document.getElementById('btnDeleteBook');
                        const btnUpdate = document.querySelector('button[form="updateBookForm"]') || updateForm.querySelector('.btn-primary');

                        // --- AJAX Update Logic ---
                        if (btnUpdate) {
                            btnUpdate.type = 'button'; // Prevent default submit
                            btnUpdate.addEventListener('click', async function () {
                                const formData = new FormData(updateForm);
                                const data = Object.fromEntries(formData.entries());

                                // Explicitly get description value to be safe
                                const descVal = document.getElementById('modalBookDescription').value;
                                data.description = descVal;

                                // Checkbox handling
                                data.isVisible = document.getElementById('modalBookVisible').checked ? 'on' : 'off';

                                // Checkbox handling for Categories
                                const selectedCats = [];
                                document.querySelectorAll('.category-checkbox:checked').forEach(cb => {
                                    selectedCats.push(cb.value);
                                });
                                data.categoryIds = selectedCats;

                                try {
                                    const response = await fetch(updateForm.action, {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'Accept': 'application/json',
                                            'X-Requested-With': 'XMLHttpRequest'
                                        },
                                        body: JSON.stringify(data)
                                    });

                                    const result = await response.json();

                                    if (result.success) {
                                        // Update Table Row directly to avoid reload
                                        const bookId = document.getElementById('modalBookId').value;
                                        const row = document.getElementById('tr-' + bookId);
                                        if (row) {
                                            const book = result.book; // Backend returns updated book

                                            // Update Data Attributes
                                            row.dataset.title = book.title;
                                            row.dataset.author = book.author;
                                            row.dataset.isbn = book.isbn || '';
                                            row.dataset.price = book.price || 0;
                                            row.dataset.priceCost = book.price_cost || 0;
                                            row.dataset.isVisible = book.isVisible;
                                            row.dataset.image = book.imageUrl;
                                            row.dataset.updatedAt = new Date(book.updatedAt).toLocaleString();

                                            // Update Cells
                                            const cells = row.cells;

                                            // Cell 0: Image
                                            const img = cells[0].querySelector('img');
                                            if (img) img.src = book.imageUrl;

                                            // Cell 1: Title/Author
                                            cells[1].innerHTML = `<strong>${book.title}</strong><br><small class="text-muted">${book.author}</small>`;

                                            // Cell 2: ISBN
                                            cells[2].textContent = book.isbn || '-';

                                            // Cell 3: Price
                                            cells[3].textContent = 'R' + (book.price ? parseFloat(book.price).toFixed(2) : '0.00');

                                            // Cell 6: Updated At
                                            cells[6].textContent = new Date(book.updatedAt).toLocaleDateString();

                                            // Cell 7: Status
                                            if (book.isVisible) {
                                                cells[7].innerHTML = '<span class="badge bg-success">Visible</span>';
                                            } else {
                                                cells[7].innerHTML = '<span class="badge bg-warning text-dark">Hidden</span>';
                                            }
                                        }
                                        editModal.hide();
                                        // Highlight row briefly to show success
                                        if (row) {
                                            row.classList.add('table-success');
                                            setTimeout(() => row.classList.remove('table-success'), 1500);
                                        }
                                    } else {
                                        alert('Update failed: ' + (result.error || 'Unknown error'));
                                    }
                                } catch (err) {
                                    console.error(err);
                                    alert('Error updating book: ' + err.message);
                                }
                            });
                        }

                        // --- Populate Modal ---
                        document.querySelectorAll('.clickable-row').forEach(row => {
                            row.addEventListener('click', function (e) {
                                // If the click was on a button or an icon inside a button, don't trigger modal
                                if (e.target.closest('button')) return;

                                const ds = this.dataset;

                                // Highlight the row and save ID
                                document.querySelectorAll('.table-highlight').forEach(el => el.classList.remove('table-highlight'));
                                this.classList.add('table-highlight');
                                localStorage.setItem(STORAGE_KEY, ds.id);

                                // Set Form Actions
                                updateForm.action = `/admin/books/${ds.id}/update`;

                                // Set Hidden ID for DOM Update
                                document.getElementById('modalBookId').value = ds.id;

                                // Store ID for delete
                                btnDelete.dataset.deleteUrl = `/admin/books/${ds.id}/delete`;

                                // Set Values
                                document.getElementById('modalBookTitle').value = ds.title;
                                document.getElementById('modalBookAuthor').value = ds.author;
                                document.getElementById('modalBookIsbn').value = ds.isbn;

                                // Read description from hidden div (safer for quotes/newlines)
                                const descEl = document.getElementById(`desc-${ds.id}`);
                                document.getElementById('modalBookDescription').value = descEl ? descEl.textContent.trim() : '';

                                document.getElementById('modalBookStock').value = ds.stock;

                                // Handle Multiple Categories (Checkboxes)
                                const selectedCategoryIds = JSON.parse(ds.categories || '[]');
                                document.querySelectorAll('.category-checkbox').forEach(cb => {
                                    cb.checked = selectedCategoryIds.includes(cb.value);
                                });
                                // Ensure price uses period decimal separator (South African standard)
                                const priceValue = parseFloat(ds.price);
                                document.getElementById('modalBookPrice').value = isNaN(priceValue) ? '' : priceValue.toFixed(2);

                                const priceCostValue = parseFloat(ds.priceCost);
                                document.getElementById('modalBookPriceCost').value = isNaN(priceCostValue) ? '' : priceCostValue.toFixed(2);
                                document.getElementById('modalBookImage').value = ds.image;
                                document.getElementById('modalBookThumbnail').src = ds.image;

                                document.getElementById('modalCreatedAt').textContent = ds.createdAt;
                                document.getElementById('modalUpdatedAt').textContent = ds.updatedAt;

                                // Handle Checkbox
                                document.getElementById('modalBookVisible').checked = (ds.isVisible === 'true');

                                editModal.show();
                            });
                        });

                        document.getElementById('btnFetchGoogleData').addEventListener('click', async function () {
                            const isbnInput = document.getElementById('modalBookIsbn');
                            const isbn = isbnInput.value;
                            const btn = this;
                            const originalHTML = '<i class="bi bi-cloud-download"></i> Fetch from Google';

                            // Helper for temporary feedback
                            const showFeedback = (msg, cls) => {
                                btn.innerHTML = msg;
                                btn.classList.remove('btn-warning');
                                btn.classList.add(cls);
                                setTimeout(() => {
                                    btn.innerHTML = originalHTML;
                                    btn.classList.remove(cls);
                                    btn.classList.add('btn-warning');
                                    btn.disabled = false;
                                }, 2000);
                            };

                            if (!isbn || isbn.trim().length === 0) {
                                isbnInput.focus();
                                showFeedback('No ISBN!', 'btn-danger');
                                return;
                            }

                            // Disable button and show loading state
                            btn.disabled = true;
                            btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Fetching...';

                            try {
                                const query = `isbn:${isbn.trim()}`;
                                const apiKey = '<%= process.env.GOOGLE_BOOK_API || "" %>';
                                const url = `https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(query)}&maxResults=1${apiKey ? '&key=' + apiKey : ''}`;


                                const response = await fetch(url);
                                const data = await response.json();

                                if (data.items && data.items.length > 0) {
                                    const book = data.items[0].volumeInfo;

                                    // Populate form fields (but don't save)
                                    if (book.title) {
                                        document.getElementById('modalBookTitle').value = book.title.substring(0, 255);
                                    }

                                    if (book.authors && book.authors.length > 0) {
                                        document.getElementById('modalBookAuthor').value = book.authors.join(', ').substring(0, 2000);
                                    }

                                    if (book.description) {
                                        document.getElementById('modalBookDescription').value = book.description.substring(0, 4000);
                                    }

                                    // Handle image URL
                                    if (book.imageLinks) {
                                        const imageUrl = (book.imageLinks.thumbnail || book.imageLinks.smallThumbnail || '').substring(0, 255);
                                        if (imageUrl) {
                                            document.getElementById('modalBookImage').value = imageUrl;
                                            document.getElementById('modalBookThumbnail').src = imageUrl;
                                        }
                                    }


                                    // Update categories using subject trigger matching
                                    if (book.categories && book.categories.length > 0) {
                                        try {
                                            // Call backend to match categories using subject_triggers
                                            const categoryResponse = await fetch('/admin/books/match-categories', {
                                                method: 'POST',
                                                headers: {
                                                    'Content-Type': 'application/json',
                                                    'Accept': 'application/json'
                                                },
                                                body: JSON.stringify({
                                                    subjects: book.categories
                                                })
                                            });

                                            const categoryData = await categoryResponse.json();

                                            if (categoryData.success && categoryData.categoryIds) {
                                                // Uncheck all first
                                                document.querySelectorAll('.category-checkbox').forEach(cb => cb.checked = false);

                                                // Check matched categories
                                                categoryData.categoryIds.forEach(catId => {
                                                    const checkbox = document.querySelector(`.category-checkbox[value="${catId}"]`);
                                                    if (checkbox) checkbox.checked = true;
                                                });
                                            }
                                        } catch (catErr) {
                                            console.warn('Category matching error:', catErr);
                                        }
                                    }

                                    showFeedback('Fetched!', 'btn-success');
                                } else {
                                    showFeedback('Not Found', 'btn-danger');
                                }
                            } catch (err) {
                                console.error('Google API Error:', err);
                                showFeedback('Error', 'btn-danger');
                            }
                        });


                        // --- Delete Logic ---
                        btnDelete.addEventListener('click', async function () {
                            const url = this.dataset.deleteUrl;
                            if (url && confirm('Are you sure you want to delete this book? This cannot be undone.')) {
                                try {
                                    const response = await fetch(url, {
                                        method: 'POST',
                                        headers: {
                                            'Accept': 'application/json',
                                            'X-Requested-With': 'XMLHttpRequest'
                                        }
                                    });

                                    const result = await response.json();

                                    if (result.success) {
                                        const bookId = document.getElementById('modalBookId').value;
                                        const row = document.getElementById('tr-' + bookId);
                                        if (row) {
                                            row.remove(); // Remove the row from the table
                                        }
                                        editModal.hide(); // Hide the modal
                                        // Optional: Show a success toast
                                    } else {
                                        alert('Delete failed: ' + (result.error || 'Unknown error'));
                                    }
                                } catch (err) {
                                    console.error(err);
                                    alert('Error deleting book: ' + err.message);
                                }
                            }
                        });

                        // --- Draggable Logic ---
                        const modalDialog = editModalEl.querySelector('.modal-dialog');
                        const modalHeader = editModalEl.querySelector('.modal-header');

                        let isDragging = false;
                        let startX, startY;
                        let startLeft, startTop;

                        modalHeader.addEventListener('mousedown', function (e) {
                            if (e.button !== 0 || e.target.closest('.btn-close')) return;

                            isDragging = true;
                            startX = e.clientX;
                            startY = e.clientY;

                            const style = window.getComputedStyle(modalDialog);
                            const matrix = new WebKitCSSMatrix(style.transform);
                            startLeft = matrix.m41;
                            startTop = matrix.m42;

                            modalHeader.style.cursor = 'grabbing';
                        });

                        window.addEventListener('mousemove', function (e) {
                            if (!isDragging) return;
                            e.preventDefault();

                            const dx = e.clientX - startX;
                            const dy = e.clientY - startY;

                            modalDialog.style.transform = `translate(${startLeft + dx}px, ${startTop + dy}px)`;
                        });

                        window.addEventListener('mouseup', function () {
                            if (isDragging) {
                                isDragging = false;
                                modalHeader.style.cursor = 'move';
                            }
                        });

                        // --- AJAX Visibility Toggle ---
                        document.querySelectorAll('.btn-toggle-visibility').forEach(btn => {
                            btn.addEventListener('click', async function () {
                                const bookId = this.dataset.id;
                                const currentVisible = this.dataset.visible === 'true';

                                try {
                                    const response = await fetch(`/admin/books/${bookId}/toggle`, {
                                        method: 'POST',
                                        headers: {
                                            'Accept': 'application/json',
                                            'X-Requested-With': 'XMLHttpRequest'
                                        }
                                    });

                                    const result = await response.json();

                                    if (result.success) {
                                        // Toggle UI State
                                        const newVisible = !currentVisible;
                                        this.dataset.visible = newVisible;

                                        // Update Button
                                        const icon = this.querySelector('i');
                                        this.className = `btn btn-sm ${newVisible ? 'btn-outline-success' : 'btn-outline-warning'} btn-toggle-visibility`;
                                        this.title = newVisible ? 'Hide Book' : 'Show Book';
                                        icon.className = `bi ${newVisible ? 'bi-eye' : 'bi-eye-slash'}`;

                                        // Update Badge (find specific row)
                                        const row = document.getElementById(`tr-${bookId}`);
                                        if (row) {
                                            // Look for the cell containing the badge. Usually index 5.
                                            // To be safe, look for the cell with a badge.
                                            const badge = row.querySelector('.badge');
                                            if (badge) {
                                                if (newVisible) {
                                                    badge.className = 'badge bg-success';
                                                    badge.textContent = 'Visible';
                                                } else {
                                                    badge.className = 'badge bg-warning text-dark';
                                                    badge.textContent = 'Hidden';
                                                }
                                            }
                                        }
                                    } else {
                                        console.error('Toggle failed');
                                        alert('Failed to toggle visibility: ' + (result.error || 'Unknown error'));
                                    }
                                } catch (err) {
                                    console.error(err);
                                    alert('Error: ' + err.message);
                                }
                            });
                        });
                    });
                </script>
            </div>