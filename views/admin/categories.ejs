<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Category Maintenance</h1>
        <div>
            <a href="/admin" class="btn btn-secondary me-2">Back to Dashboard</a>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#editCategoryModal"
                onclick="openCreateModal()">
                <i class="fas fa-plus"></i> New Category
            </button>
        </div>
    </div>

    <!-- Advanced Search Card -->
    <div class="card mb-3 admin-panel-dark">
        <div class="card-header d-flex justify-content-between align-items-center" data-bs-toggle="collapse"
            data-bs-target="#searchPanel" style="cursor: pointer;">
            <span class="fw-bold">Search Categories</span>
            <i class="fas fa-chevron-down text-light"></i>
        </div>
        <div class="collapse show" id="searchPanel">
            <div class="card-body">
                <form action="/admin/categories" method="GET" class="row g-3">
                    <div class="col-md-10">
                        <label for="search" class="form-label">Category Name</label>
                        <input type="text" class="form-control" id="search" name="search" value="<%= search %>"
                            placeholder="Search by name...">
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100">Search</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="mb-3 text-secondary">
        Total Categories: <strong>
            <%= totalCategories %>
        </strong> (Page <%= currentPage %> of <%= totalPages %>)
    </div>

    <!-- Data Grid -->
    <div class="card admin-panel-dark">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0 align-middle">
                    <thead class="table-dark">
                        <tr>
                            <th>Name</th>
                            <th>Created At</th>
                            <th>Updated At</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% if (categories.length===0) { %>
                            <tr>
                                <td colspan="4" class="text-center py-4 text-muted">No categories found.</td>
                            </tr>
                            <% } else { %>
                                <% categories.forEach(category=> { %>
                                    <tr data-id="<%= category.id %>" onclick="highlightRow(this)">
                                        <td><strong>
                                                <%= category.name %>
                                            </strong></td>
                                        <td>
                                            <%= new Date(category.createdAt).toLocaleDateString() %>
                                        </td>
                                        <td>
                                            <%= new Date(category.updatedAt).toLocaleDateString() %>
                                        </td>
                                        <td class="text-end">
                                            <button class="btn btn-sm btn-outline-primary me-1"
                                                onclick="openEditModal('<%= category.id %>', '<%= category.name %>')">
                                                <i class="fas fa-edit"></i>
                                            </button>

                                        </td>
                                    </tr>
                                    <% }) %>
                                        <% } %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Pagination -->
    <% if (totalPages> 1) { %>
        <div class="admin-panel-dark p-2 rounded mt-3">
            <nav>
                <ul class="pagination justify-content-center mb-0">
                    <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
                        <a class="page-link"
                            href="/admin/categories?page=<%= currentPage - 1 %>&search=<%= search %>">Previous</a>
                    </li>
                    <% for(let i=1; i <=totalPages; i++) { %>
                        <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                            <a class="page-link" href="/admin/categories?page=<%= i %>&search=<%= search %>">
                                <%= i %>
                            </a>
                        </li>
                        <% } %>
                            <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
                                <a class="page-link"
                                    href="/admin/categories?page=<%= currentPage + 1 %>&search=<%= search %>">Next</a>
                            </li>
                </ul>
            </nav>
        </div>
        <% } %>
</div>

<!-- Edit/Create Modal -->
<div class="modal fade" id="editCategoryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Edit Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="categoryForm" action="/admin/categories/update" method="POST">
                <div class="modal-body">
                    <input type="hidden" id="catId" name="id">
                    <div class="mb-3">
                        <label for="catName" class="form-label">Category Name</label>
                        <input type="text" class="form-control" id="catName" name="name" required>
                    </div>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" id="btnDeleteCategory" class="btn btn-danger" style="display: none;"
                        onclick="deleteCategory()">Delete</button>
                    <div>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function openCreateModal() {
        document.getElementById('modalTitle').innerText = 'New Category';
        document.getElementById('categoryForm').action = '/admin/categories/create';
        document.getElementById('catId').value = '';
        document.getElementById('catName').value = '';
        document.getElementById('btnDeleteCategory').style.display = 'none'; // Hide delete for create
    }

    function openEditModal(id, name) {
        console.log('[DEBUG] openEditModal called', { id, name });
        document.getElementById('modalTitle').innerText = 'Edit Category';
        document.getElementById('categoryForm').action = `/admin/categories/${id}/update`;
        document.getElementById('catId').value = id;
        document.getElementById('catName').value = name;

        const btnDelete = document.getElementById('btnDeleteCategory');
        btnDelete.style.display = 'block'; // Show delete for edit
        btnDelete.dataset.deleteUrl = `/admin/categories/${id}/delete`;
        console.log('[DEBUG] Delete button configured', {
            display: btnDelete.style.display,
            deleteUrl: btnDelete.dataset.deleteUrl
        });

        var modal = new bootstrap.Modal(document.getElementById('editCategoryModal'));
        modal.show();
    }

    // Row Highlighting Persistence
    function highlightRow(row) {
        document.querySelectorAll('tr').forEach(r => r.classList.remove('table-highlight'));
        row.classList.add('table-highlight');
        localStorage.setItem('lastCategoryRow', row.dataset.id);
    }

    async function deleteCategory() {
        const btn = document.getElementById('btnDeleteCategory');
        const url = btn.dataset.deleteUrl;

        if (url && confirm('Are you sure you want to delete this category? This cannot be undone.')) {
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    window.location.reload();
                } else {
                    alert('Delete failed: ' + (result.error || 'Unknown error'));
                }
            } catch (err) {
                console.error(err);
                alert('Error deleting category: ' + err.message);
            }
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Restore Highlight
        const lastId = localStorage.getItem('lastCategoryRow');
        if (lastId) {
            const row = document.querySelector(`tr[data-id="${lastId}"]`);
            if (row) {
                row.classList.add('table-highlight');
                row.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
    });
</script>

<style>
    .table-highlight {
        background-color: #e2f0fd !important;
    }

    [data-theme="dark"] .table-highlight {
        background-color: #375a7f !important;
    }
</style>